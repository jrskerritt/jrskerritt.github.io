<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" href="../favicon.ico" type="image/x-icon">
        <link rel="stylesheet" href="../css/bootstrap.min.css">
        <link rel="stylesheet" href="http://yandex.st/highlightjs/8.0/styles/default.min.css">
        <link rel="stylesheet" href="../css/blog.css">
        
        <title>Creating a simple express.js and socket.io app - Jim Skerritt</title>

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body id="top">
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../">Jim Skerritt</a>
                </div>
                <div class="navbar-collapse collapse" id="navbar">
                    <ul class="nav navbar-nav">
                        <li>
                            <a href="../">Blog</a>
                        </li>
                        <li>
                            <a href="../about.html">About</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="container main">
            <div class="row">
                <div class="col-sm-8 blog-main">
                    <div class="blog-post-header">
                        <h1>Creating a basic express.js and socket.io app</h1>
                        <h4>April 6, 2014</h4>
                    </div>
                </div>
                <div class="col-sm-3 col-sm-offset-1"></div>
            </div>

            <div class="row">
                <div class="col-sm-8 blog-post">


<p>The other day at the office, a conversation began about the hassle of needing a tab of realtime Google Analytics open for each of our websites. We could only Chromecast one or two tabs at a time onto our office TV. Wouldn&#39;t it be nice to somehow watch the traffic for each website, along with a running total in realtime, all on one nicely castable tab?</p>
<p>The keyword here was <strong>realtime</strong>. It gave me the idea to try out <a href="http://socket.io/">socket.io</a> to create a simple application that these tabs of Analytics could post their current realtime numbers to, and the app could emit the latest numbers out to a web page for viewing. <a href="http://expressjs.com/">Express.js</a> would be perfect for this to quickly get an effective application going.</p>
<p>The code turned out to be very simple:</p>
<pre><code class="lang-javascript">var express = require(&#39;express&#39;)
,   app = express()
,   server = app.listen(9132)
,   io = require(&#39;socket.io&#39;).listen(server);

app.use(express.json());
app.use(express.urlencoded());
app.use(express.static(__dirname + &#39;/public&#39;));


var trafficData = {};

// parameters:
// site - the string of the site name
// n - the count
app.post(&#39;/&#39;, function (req, res) {
    trafficData[req.body.site] = req.body.n;
});

io.sockets.on(&#39;connection&#39;, function (socket) {
    socket.on(&#39;traffic-req&#39;, function () {
        socket.emit(&#39;traffic-res&#39;, trafficData);
    });
});</code></pre>
<p>The server listens on port <code>9132</code> for incoming post requests. Every time one is recevied, the data is stored or updated in an object called <code>trafficData</code> using the site name as the key and the current number of users on the site as the value. </p>
<p>On the client, we have to request for this data periodically and then update then numbers on the page.</p>
<pre><code class="lang-javascript">var socket = io.connect(&#39;/&#39;);

$(function() {
    socket.on(&#39;traffic-res&#39;, function(res) {
        refresh(res);
    });

    setInterval(function() {
        socket.emit(&#39;traffic-req&#39;);
    }, 2500);
});</code></pre>
<p>Once we set up a connection to a socket, our script will emit requests every 2.5 seconds. Upon receiving a response, the <code>refresh</code> function iterates over each key-value pair and updates the DOM with new traffic numbers.</p>
<p>The last step is to hook up our open realtime Analytics tabs to post the data that we want to our Express app.</p>
<pre><code class="lang-javascript">javascript: (function() {if (!($ = window.jQuery)) {script = document.createElement( &#39;script&#39; ); script.src = &#39;//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js&#39;; script.onload=bmf; document.body.appendChild(script); } else { bmf(); } function bmf() { var xhr; var site = $(&#39;[class*=&quot;accounts-summary&quot;]&#39;).find(&#39;li:last-child&#39;).find(&#39;span&#39;).text().split(&#39; &#39;)[0]; var fn = function(){ if(xhr &amp;&amp; xhr.readystate != 4){ xhr.abort(); } var count = $(&#39;#ID-overviewCounterValue&#39;).text(); xhr = $.ajax({ url: &#39;http://localhost:9132&#39;, type: &#39;POST&#39;, data: {site:site, n:count }}); }; var interval = setInterval(fn, 2000); }}());</code></pre>
<p>This script is designed to be added as a bookmark, then every time you open an Analytics page that you want to track, you just open the bookmark, and the traffic numbers will start getting posted to the Express server every 2 seconds.</p>
<p>And that&#39;s it! Once all the pieces are in place, realtime traffic numbers will start appearing on your Express page. Very quick and easy, and now we only ever need to have one instance of Analytics open for each website. Our Express server and Google Analytics tabs run on the same Linux server for our needs, allowing anyone in the office to browse to that machine&#39;s IP on port <code>9132</code> and watch the numbers without having to open all those Analytics tabs for themselves.</p>
<p>You can check out the entire source code for the application on Github here: <a href="https://github.com/jrskerritt/niche-rt">https://github.com/jrskerritt/niche-rt</a></p>


                </div>
                <div class="col-sm-3 col-sm-offset-1">
                    <div class="sidebar-module sidebar-module-inset">
                        <h4>About</h4>
                        <p>
                            Jim is a software developer living in Pittsburgh, PA. He currently works at <a href="http://niche.com/">Niche</a> as a software engineer creating web applications that help people search and compare colleges and K-12 schools.
                        </p>
                    </div>
                    <div class="sidebar-module">
                        <h4>Links</h4>
                        <ol class="list-unstyled">
                            <li><a href="https://github.com/jrskerritt">GitHub</a></li>
                            <li><a href="https://twitter.com/JimSkerritt">Twitter</a></li>
                            <li><a href="http://stackoverflow.com/users/1176168/jim-skerritt">Stack Overflow</a></li>
                            <li><a href="http://www.linkedin.com/in/jrskerritt">LinkedIn</a></li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p><a href="#top">Back to top</a></p>
        </div>

        <script src="../js/jquery-1.11.0.min.js" type="text/javascript"></script>
        <script src="../js/bootstrap.min.js" type="text/javascript"></script>
        <script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>